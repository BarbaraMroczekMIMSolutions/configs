#!/usr/bin/env python
# coding: utf-8

# In[1]:


# output of http://localhost:8888/api/sessions
sessions_list = [{"id": "bf44f7db-6dd7-47f7-bac0-59d5ecd08ce5", "path": "pwygocki/sources/optymalizacja_rabatu/ipython/CSI-wygos-Copy1.ipynb", "name": "", "type": "notebook", "kernel": {"id": "0cbaa494-4e74-47e2-9137-77b3b072c9a8", "name": "rossmann_discount", "last_activity": "2020-07-15T11:47:53.731176Z", "execution_state": "idle", "connections": 0}, "notebook": {"path": "pwygocki/sources/optymalizacja_rabatu/ipython/CSI-wygos-Copy1.ipynb", "name": ""}}, {"id": "3e28c919-ece9-477b-98bd-ecf89496e98d", "path": "pwygocki/sources/optymalizacja_rabatu/ipython/CSI-wygos.ipynb", "name": "", "type": "notebook", "kernel": {"id": "cd615e00-bfdf-4ab9-949b-07066c86145e", "name": "rossmann_discount", "last_activity": "2020-07-14T07:46:51.312588Z", "execution_state": "starting", "connections": 0}, "notebook": {"path": "pwygocki/sources/optymalizacja_rabatu/ipython/CSI-wygos.ipynb", "name": ""}}, {"id": "f84f6ac7-64a4-4072-a8f0-57606af31695", "path": "bmroczek/ipython_memory/memory_usage_all_notebooks.ipynb", "name": "", "type": "notebook", "kernel": {"id": "47e821ad-1990-41af-9df0-cfbf35a3d105", "name": "rossmann_discount", "last_activity": "2020-08-12T14:41:15.782700Z", "execution_state": "idle", "connections": 2}, "notebook": {"path": "bmroczek/ipython_memory/memory_usage_all_notebooks.ipynb", "name": ""}}, {"id": "b33ca5df-6c75-4ca9-9d87-98b098423979", "path": "bmroczek/optymalizacja_rabatu_copy2/ipython/listplus_stats.ipynb", "name": "", "type": "notebook", "kernel": {"id": "302537c4-f4da-49f7-acaa-26b9b9b06f44", "name": "rossmann_discount", "last_activity": "2020-08-11T10:07:58.576366Z", "execution_state": "idle", "connections": 0}, "notebook": {"path": "bmroczek/optymalizacja_rabatu_copy2/ipython/listplus_stats.ipynb", "name": ""}}, {"id": "7e4b8880-cc31-456a-a901-74bb79f4a7f6", "path": "bmroczek/optymalizacja_rabatu_copy2/ipython/listplus_model.ipynb", "name": "", "type": "notebook", "kernel": {"id": "742255a1-8ddf-4f27-a5f6-5159b090bea6", "name": "rossmann_discount", "last_activity": "2020-08-12T10:21:51.411662Z", "execution_state": "idle", "connections": 0}, "notebook": {"path": "bmroczek/optymalizacja_rabatu_copy2/ipython/listplus_model.ipynb", "name": ""}}, {"id": "c88296e2-c0af-4029-8f27-b497deeb2690", "path": "bmroczek/optymalizacja_rabatu_copy2/ipython/hive_test.ipynb", "name": "", "type": "notebook", "kernel": {"id": "12b723b4-f608-4377-bbe8-0d120787a588", "name": "rossmann_discount", "last_activity": "2020-08-06T10:27:22.108683Z", "execution_state": "idle", "connections": 0}, "notebook": {"path": "bmroczek/optymalizacja_rabatu_copy2/ipython/hive_test.ipynb", "name": ""}}, {"id": "e61c1dd4-3a10-4b43-9ff1-49e2928cc33d", "path": "awitkowski/optymalizacja_rabatu/ipython/train_model.ipynb", "name": "", "type": "notebook", "kernel": {"id": "b0457b74-59d8-41ba-aa14-e56d62b02adb", "name": "rossmann_discount", "last_activity": "2020-08-07T11:21:01.213514Z", "execution_state": "idle", "connections": 0}, "notebook": {"path": "awitkowski/optymalizacja_rabatu/ipython/train_model.ipynb", "name": ""}}, {"id": "2dd6d0ed-a22a-4b01-a396-b11110bfad97", "path": "awitkowski/optymalizacja_rabatu/ipython/listplus_model_lgb.ipynb", "name": "", "type": "notebook", "kernel": {"id": "d844321a-7ba2-4e9a-b765-f4117106e878", "name": "rossmann_discount", "last_activity": "2020-08-08T23:11:19.171462Z", "execution_state": "idle", "connections": 0}, "notebook": {"path": "awitkowski/optymalizacja_rabatu/ipython/listplus_model_lgb.ipynb", "name": ""}}, {"id": "c853a24d-7163-4680-8ed2-c1de21d75986", "path": "mzielen/optymalizacja_hive/ipython/test_hive.ipynb", "name": "", "type": "notebook", "kernel": {"id": "b2a39331-bf83-476c-b528-89ac772f15d8", "name": "rossmann_discount", "last_activity": "2020-08-10T12:39:16.648327Z", "execution_state": "idle", "connections": 0}, "notebook": {"path": "mzielen/optymalizacja_hive/ipython/test_hive.ipynb", "name": ""}}, {"id": "12076de8-d734-448a-96de-e393fdf0e81d", "path": "gsobczak/repos/for_reviews/ipython/listplus_model.ipynb", "name": "", "type": "notebook", "kernel": {"id": "fb68d095-859f-4118-aa2a-9b23bddba2b4", "name": "rossmann_discount", "last_activity": "2020-08-10T10:01:10.371632Z", "execution_state": "idle", "connections": 0}, "notebook": {"path": "gsobczak/repos/for_reviews/ipython/listplus_model.ipynb", "name": ""}}, {"id": "4d2bd45a-b75d-426b-95f9-3cd949d87f3d", "path": "gsobczak/repos/for_rest/ipython/listplus_model.ipynb", "name": "", "type": "notebook", "kernel": {"id": "0ae44c78-56b4-4ea6-a216-5669bc796dab", "name": "rossmann_discount", "last_activity": "2020-08-12T14:39:10.236996Z", "execution_state": "busy", "connections": 1}, "notebook": {"path": "gsobczak/repos/for_rest/ipython/listplus_model.ipynb", "name": ""}}, {"id": "97d4cdf1-7a75-4d4f-81b7-ac3767be03e9", "path": "bmroczek/optymalizacja_rabatu_copy2/ipython/Analiza_CSI.ipynb", "name": "", "type": "notebook", "kernel": {"id": "86136b4b-61e1-4eb4-9a90-92a34cb4c131", "name": "rossmann_discount", "last_activity": "2020-08-12T10:37:46.060793Z", "execution_state": "idle", "connections": 0}, "notebook": {"path": "bmroczek/optymalizacja_rabatu_copy2/ipython/Analiza_CSI.ipynb", "name": ""}}, {"id": "649b9fd4-3f7c-4118-8f8e-97b2ef49cdca", "path": "mzielen/optymalizacja_tensor_board/ipython/sale_prediction/Untitled.ipynb", "name": "", "type": "notebook", "kernel": {"id": "c014fca3-ebfc-4528-bda8-ef50ba2e9942", "name": "torch", "last_activity": "2020-08-12T11:04:05.289139Z", "execution_state": "idle", "connections": 0}, "notebook": {"path": "mzielen/optymalizacja_tensor_board/ipython/sale_prediction/Untitled.ipynb", "name": ""}}, {"id": "333e98b2-0a17-49c3-913c-6f8329f9042c", "path": "bmroczek/optymalizacja_rabatu_copy2/ipython/listplus_checks_exploration.ipynb", "name": "", "type": "notebook", "kernel": {"id": "6a685b38-2515-4372-8baa-f8ac0bf615e5", "name": "rossmann_discount", "last_activity": "2020-08-12T14:13:26.130862Z", "execution_state": "idle", "connections": 1}, "notebook": {"path": "bmroczek/optymalizacja_rabatu_copy2/ipython/listplus_checks_exploration.ipynb", "name": ""}}, {"id": "5f448800-0451-4b04-8d9b-0e78c3ea8588", "path": "mzielen/optymalizacja_tensor_board/ipython/sale_prediction/train_sale_prediction_model-torch.ipynb", "name": "", "type": "notebook", "kernel": {"id": "098bc613-6bb6-4680-af50-735f3120d899", "name": "torch", "last_activity": "2020-08-12T14:41:31.523383Z", "execution_state": "busy", "connections": 1}, "notebook": {"path": "mzielen/optymalizacja_tensor_board/ipython/sale_prediction/train_sale_prediction_model-torch.ipynb", "name": ""}}]


# In[2]:


len(sessions_list)


# In[3]:


import pandas as pd


# In[4]:


pd.set_option('display.max_colwidth', -1)


# In[5]:


def get_pid_from_kernel(kernel, ps_out):
    search_out = ps_out.grep(kernel)
    if len(search_out) == 0:
        return None
    elif len(search_out) > 1:
        print('More than 1 process found')
        print(search_out)
    pid = search_out[0].split()[0]
    return pid


# In[6]:


def get_cpu_usage(pid):
    if pid is None:
        return 0
    out = get_ipython().getoutput('ps -p $pid -o %mem')
    return float(out[1])


# In[7]:


def get_gpu_usage(pid, nvidia_out):
    if pid is None:
        return 0
    nvidia_out = nvidia_out.grep(str(pid))
    if len(nvidia_out) > 0:
        ret = nvidia_out[0].split()[-2]
        ret = int(ret[:-3])
    else:
        ret = 0
    return ret


# In[16]:


get_ipython().run_cell_magic('time', '', "# refresh to get current resourses used by sessions_list notebooks

usage_df = pd.DataFrame()

ps_out = ! ps ax
nvidia_out = ! nvidia-smi

for ses in sessions_list:
    ses_dict = {}
    ses_dict['path'] = ses['path']
    ses_dict['last_active'] = ses['kernel']['last_activity']
    ses_dict['pid'] = get_pid_from_kernel(ses['kernel']['id'], ps_out)
    ses_dict['cpu_usage (%)'] = get_cpu_usage(ses_dict['pid'])
    ses_dict['gpu_in_MiB'] = get_gpu_usage(ses_dict['pid'], nvidia_out)
    ses_dict['gpu_usage (%)'] = 100 * ses_dict['gpu_in_MiB'] / 7982
    
    ses_df = pd.DataFrame([ses_dict])
    usage_df = usage_df.append(ses_df)

usage_df = usage_df.sort_values(by =['cpu_usage (%)', 'gpu_usage (%)'], ascending=False).reset_index(drop=True)
display(usage_df)")


# In[10]:


print('Total usage of CPU')
print(sum(usage_df['cpu_usage (%)']))


# In[11]:


print('Total usage of GPU')
print(f'{100 * sum(usage_df.gpu_in_MiB) / 7982:.1f}')


# In[12]:


print('Notebooks with alocated GPU')
display(usage_df[usage_df.gpu_in_MiB > 0])


# In[13]:


list(usage_df[usage_df.gpu_in_MiB > 0].path)


# In[14]:


usage_df.head(5)['path'].to_list()


# In[17]:


user_name = 'bmroczek'
print(f'Notebooks of user {user_name}')
display(usage_df[usage_df.path.str.split('/').str[0] == 'bmroczek'])


# In[ ]:




